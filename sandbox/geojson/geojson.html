<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	 "http://www.w3.org/TR/html4/strict.dtd">

<html>

<head>

	<meta http-equiv="content-type" content="text/html;charset=utf-8">
	<script type="text/javascript" src="../build/three.min.js"></script>
<!-- JSModeler includes start -->
	<script type="text/javascript" src="../../src/core/jsm.js"></script>
	<script type="text/javascript" src="../../src/core/timer.js"></script>
	<script type="text/javascript" src="../../src/core/algorithm.js"></script>
	<script type="text/javascript" src="../../src/core/async.js"></script>
	<script type="text/javascript" src="../../src/core/check.js"></script>
	<script type="text/javascript" src="../../src/core/jsonloader.js"></script>
	<script type="text/javascript" src="../../src/geometry/definitions.js"></script>
	<script type="text/javascript" src="../../src/geometry/coord2d.js"></script>
	<script type="text/javascript" src="../../src/geometry/coord.js"></script>
	<script type="text/javascript" src="../../src/geometry/determinant.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordutils.js"></script>
	<script type="text/javascript" src="../../src/geometry/matrix.js"></script>
	<script type="text/javascript" src="../../src/geometry/coordsystem.js"></script>
	<script type="text/javascript" src="../../src/geometry/sector.js"></script>
	<script type="text/javascript" src="../../src/geometry/line.js"></script>
	<script type="text/javascript" src="../../src/geometry/box.js"></script>
	<script type="text/javascript" src="../../src/geometry/sphere.js"></script>
	<script type="text/javascript" src="../../src/geometry/transformation.js"></script>
	<script type="text/javascript" src="../../src/geometry/plane.js"></script>
	<script type="text/javascript" src="../../src/geometry/projection.js"></script>
	<script type="text/javascript" src="../../src/geometry/convexhull.js"></script>
	<script type="text/javascript" src="../../src/geometry/polygon2d.js"></script>
	<script type="text/javascript" src="../../src/geometry/polygon.js"></script>
	<script type="text/javascript" src="../../src/geometry/triangulation.js"></script>
	<script type="text/javascript" src="../../src/geometry/octree.js"></script>
	<script type="text/javascript" src="../../src/geometry/bsptree.js"></script>
	<script type="text/javascript" src="../../src/geometry/utilities.js"></script>
	<script type="text/javascript" src="../../src/geometry/ray.js"></script>
	<script type="text/javascript" src="../../src/modeler/body.js"></script>
	<script type="text/javascript" src="../../src/modeler/model.js"></script>
	<script type="text/javascript" src="../../src/modeler/color.js"></script>
	<script type="text/javascript" src="../../src/modeler/material.js"></script>
	<script type="text/javascript" src="../../src/modeler/adjacencyinfo.js"></script>
	<script type="text/javascript" src="../../src/modeler/bodyutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/textureutils.js"></script>
	<script type="text/javascript" src="../../src/modeler/cututils.js"></script>
	<script type="text/javascript" src="../../src/modeler/generator.js"></script>
	<script type="text/javascript" src="../../src/modeler/camera.js"></script>
	<script type="text/javascript" src="../../src/modeler/explode.js"></script>
	<script type="text/javascript" src="../../src/modeler/exporter.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglebody.js"></script>
	<script type="text/javascript" src="../../src/modeler/trianglemodel.js"></script>
	<script type="text/javascript" src="../../src/modeler/converter.js"></script>
	<script type="text/javascript" src="../../src/modeler/rayutils.js"></script>
	<script type="text/javascript" src="../../src/import/binaryreader.js"></script>
	<script type="text/javascript" src="../../src/import/importer.js"></script>
	<script type="text/javascript" src="../../src/import/importer3ds.js"></script>
	<script type="text/javascript" src="../../src/import/importerobj.js"></script>
	<script type="text/javascript" src="../../src/import/importerstl.js"></script>
	<script type="text/javascript" src="../../src/import/importercommon.js"></script>
	<script type="text/javascript" src="../../src/renderer/webglutils.js"></script>
	<script type="text/javascript" src="../../src/renderer/renderlight.js"></script>
	<script type="text/javascript" src="../../src/renderer/rendermaterial.js"></script>
	<script type="text/javascript" src="../../src/renderer/rendermesh.js"></script>
	<script type="text/javascript" src="../../src/renderer/renderbody.js"></script>
	<script type="text/javascript" src="../../src/renderer/shaderprogram.js"></script>
	<script type="text/javascript" src="../../src/renderer/renderer.js"></script>
	<script type="text/javascript" src="../../src/renderer/pointcloudrenderer.js"></script>
	<script type="text/javascript" src="../../src/renderer/renderconverter.js"></script>
	<script type="text/javascript" src="../../src/viewer/mouse.js"></script>
	<script type="text/javascript" src="../../src/viewer/touch.js"></script>
	<script type="text/javascript" src="../../src/viewer/painter.js"></script>
	<script type="text/javascript" src="../../src/viewer/drawing.js"></script>
	<script type="text/javascript" src="../../src/viewer/navigation.js"></script>
	<script type="text/javascript" src="../../src/viewer/softwareviewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/spriteviewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/viewer.js"></script>
	<script type="text/javascript" src="../../src/viewer/pointcloudviewer.js"></script>
	<script type="text/javascript" src="../../src/extras/solidgenerator.js"></script>
	<script type="text/javascript" src="../../src/extras/extgenerator.js"></script>
	<script type="text/javascript" src="../../src/extras/subdivision.js"></script>
	<script type="text/javascript" src="../../src/extras/csg.js"></script>
	<script type="text/javascript" src="../../src/extras/curves.js"></script>
	<script type="text/javascript" src="../../src/extensions/svgtomodel/svgtomodel.js"></script>
	<script type="text/javascript" src="../../src/extensions/threeviewer/threeconverter.js"></script>
	<script type="text/javascript" src="../../src/extensions/threeviewer/threeviewer.js"></script>
<!-- JSModeler includes end -->
	<script type="text/javascript" src="../utils/hashchanger.js"></script>
	<title>Example</title>
	
	<style>
		html, body
		{
			margin : 0px;
			padding : 0px;
		}
		
		canvas
		{
			display : block;
		}
	</style>

	<script type="text/javascript">
		JSM.ModelWithMaterials = function ()
		{
			this.model = new JSM.Model ();
			this.materials = new JSM.Materials ();
		}
	
		JSM.GenerateWireBody = function (body)
		{
			var result = new JSM.Body ();
			
			var i;
			for (i = 0; i < body.VertexCount (); i++) {
				result.AddVertex (body.GetVertex (i).Clone ());
			}
		
			var adjacencyInfo = new JSM.AdjacencyInfo (body);
			var i, edge;
			for (i = 0; i < adjacencyInfo.edges.length; i++) {
				edge = adjacencyInfo.edges[i];
				JSM.AddLineToBody (result, edge.vert1, edge.vert2);
			}
			
			return result;
		};
		
		JSM.ConvertGeoJsonToModel = function (geoJson, sphereRadius)
		{
			function ConvertCoordinate (sphereRadius, coordinate)
			{
				var lon = coordinate.x * JSM.DegRad;
				var lat = (90.0 - coordinate.y) * JSM.DegRad;
				return JSM.SphericalToCartesian (sphereRadius, lat, lon);
			}
			
			function GetSegmentCount (begCoordinate, endCoordinate)
			{
				var distance = begCoordinate.DistanceTo (endCoordinate);
				var segmentCount = parseInt (distance / 10.0, 10);
				if (segmentCount === 0) {
					segmentCount = 1;
				}
				return segmentCount;
			}
			
			function AddPointToBody (body, sphereRadius, sphereCoord)
			{
				var cartesianCoord = ConvertCoordinate (sphereRadius, sphereCoord);
				var vertexIndex = JSM.AddVertexToBody (body, cartesianCoord.x, cartesianCoord.y, cartesianCoord.z);
				JSM.AddPointToBody (body, vertexIndex);			
			}
		
			function AddLineToBody (body, sphereRadius, begSphereCoord, endSphereCoord)
			{
				var sector = new JSM.Sector2D (begSphereCoord, endSphereCoord);
				var segmentCount = GetSegmentCount (begSphereCoord, endSphereCoord);
				var segmentedCoords = JSM.GetSectorSegmentation2D (sector, segmentCount);
				var i, cartesianCoord, vertexIndex;
				for (i = 0; i < segmentedCoords.length; i++) {
					cartesianCoord = ConvertCoordinate (sphereRadius, segmentedCoords[i]);
					vertexIndex = JSM.AddVertexToBody (body, cartesianCoord.x, cartesianCoord.y, cartesianCoord.z);
					if (i > 0) {
						JSM.AddLineToBody (body, vertexIndex - 1, vertexIndex);
					}
				}
			}

			function AddPoint (sphereRadius, coordinate)
			{
				if (pointsBody === null) {
					pointsBody = new JSM.Body ();
					result.model.AddBody (pointsBody);
				}
				var sphereCoord = JSM.CoordFromArray2D (coordinate);
				AddPointToBody (pointsBody, sphereRadius, sphereCoord);
			}
			
			function AddLine (sphereRadius, coordinates)
			{
				if (linesBody === null) {
					linesBody = new JSM.Body ();
					result.model.AddBody (linesBody);
				}

				var begSphereCoord = JSM.CoordFromArray2D (coordinates[0]);
				var endSphereCoord = JSM.CoordFromArray2D (coordinates[1]);
				AddLineToBody (linesBody, sphereRadius, begSphereCoord, endSphereCoord);
			}

			function AddFeature (sphereRadius, feature)
			{
				if (!feature.type || feature.type != 'Feature') {
					return false;
				}
				if (!feature.geometry || !feature.geometry.type || !feature.geometry.coordinates) {
					return false;
				}
				if (feature.geometry.type == 'Point') {
					AddPoint (sphereRadius, feature.geometry.coordinates);
				} else if (feature.geometry.type == 'LineString') {
					AddLine (sphereRadius, feature.geometry.coordinates);
				}
			}
		
			if (!geoJson.type || geoJson.type != 'FeatureCollection') {
				return null;
			}
			
			if (!geoJson.features) {
				return null;
			}
			
			var result = new JSM.ModelWithMaterials ();
			var pointsBody = null;
			var linesBody = null;
			
			var i, feature;
			for (i = 0; i < geoJson.features.length; i++) {
				feature = geoJson.features[i];
				AddFeature (sphereRadius, feature);
			}
			return result;
		}
		
		function AddEarth (sphereRadius, viewer)
		{
			var body = new JSM.GenerateSphere (sphereRadius, 20);
			body = JSM.GenerateWireBody (body);
			
			var materials = new JSM.Materials ();
			materials.AddMaterial (new JSM.Material ({ambient : 0xdddddd, diffuse : 0xdddddd}));
			body.SetLinesMaterialIndex (0);

			viewer.AddBody (JSM.ConvertBodyToRenderBody (body, materials));		
		}
		
		function RenderCurrentGeoJson (viewer, index)
		{
			viewer.RemoveBodies ();	
			viewer.Draw ();
			
			var jsonFiles = [
				'points.json',
				'lines.json'
			];
			if (index < 0 || index >= jsonFiles.length) {
				return;
			}
			
			var sphereRadius = 1.0;
			AddEarth (sphereRadius, viewer);
			JSM.LoadJsonFile (jsonFiles[index], function (jsonData) {
				var model = JSM.ConvertGeoJsonToModel (jsonData, sphereRadius);
				var renderBodies = JSM.ConvertModelToRenderBodies (model.model, model.materials);
				viewer.AddBodies (renderBodies);
				viewer.Draw ();
			});
		}
	
		function Load ()
		{
			var camera = new JSM.Camera (
				new JSM.Coord (2.0, -2.0, 2.0),
				new JSM.Coord (0.0, 0.0, 0.0),
				new JSM.Vector (0.0, 0.0, 1.0)
			);
			
			var viewer = new JSM.Viewer ();
			var canvas = document.getElementById ('example');
			if (!viewer.Init (canvas, camera)) {
				alert ('error');
			}
			
			viewer.SetFullscreen (true);
			var hashChanger = new HashChanger ();
			hashChanger.Init (function () {
				var index = hashChanger.GetHashIndex ();
				RenderCurrentGeoJson (viewer, index);
			});
		}
	
	    window.onload = function ()
		{
			Load ();
		}
	</script>

</head>

<body>
	<canvas id="example" width="800" height="500"></canvas>
</body>

</html>
